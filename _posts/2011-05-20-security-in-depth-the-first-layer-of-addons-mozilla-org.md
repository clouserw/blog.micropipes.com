---
layout: post
title: Security in Depth; the first layer of addons.mozilla.org
tags:
- Mozilla
---
<p>Discussing the security measures of a public facing and popular website is usually taboo.  Often owners are unsure they are following best practices, prefer not to draw attention to their site, or hope that they can maintain <a href="http://en.wikipedia.org/wiki/Security_through_obscurity">security through the obscurity</a> of their code.  At Mozilla we are fortunate to offer nearly all of the code in the entire company as open source software.  <a href="https://github.com/jbalogh/zamboni">addons.mozilla.org is no exception</a>.  This means we need to be extra vigilant with the code we write (and a huge thanks to our developers doing code reviews, the security and QA teams testing code, and the community members reporting bugs they find), but it also means I can write posts like this to explain some of the security measures we have implemented and how you can use them to make visitors to your sites safer too.  </p>
<p><strong>SSL Encryption</strong>:  Let's start off easy.  Anytime you go to addons.mozilla.org we redirect you to <strong>https</strong>://addons.mozilla.org.  Assuming you make it through the redirect safely you can be reasonably sure you're talking to us at that point.  Any data sent between your browser and us is encrypted with industry standard encryption.  This seems like a freebie (I know you're thinking, "really? you're talking about SSL?"), but do a quick search and you'll find <a href="http://www.firstrade.com">plenty</a> <a href="http://www.albinabank.com/">of</a> <a href="http://www.usbank.com">financial</a> <a href="http://www.discovercard.com/">institutions</a> that fail to take even this most basic precaution on pages where you submit the username and password to your accounts.</p>
<p>Alright, let's get more interesting.  AMO has a lot of user uploaded data on it, from images to files (the add-ons themselves) to the files within add-ons (we allow you to browse uploaded add-ons on the site).  If a user uploads some malicious JavaScript they'll be able to run it in the context of the addons.mozilla.org domain which would give them access to manipulate the site and change or steal user data.  We protect ourselves by <strong>using an alternate domain for user uploads</strong> - static.addons.mozilla.net.  By using .net instead of .org we've sand-boxed user scripts onto their own domain and protected the content on .org.  This is industry standard (notice how your content you upload to Google comes off of www.googleusercontent.com) and gives you a free performance boost as well.</p>
<p>Actually, uploaded images should get special mention.  It's a best practice to always clean and verify user data but this is often overlooked for images.  Back in the days of IE6 you could actually <a href="http://kestas.kuliukas.com/JavaScriptImage/">run arbitrary JavaScript embedded in the comments of an image</a>.  This has since been fixed in the browser but poorly configured servers and applications can still pose a threat.  <a href="https://nealpoole.com">Neal Poole</a> demonstrated a proof of concept on a Mozilla site where he embedded PHP in an image, saved it as "image.php" and uploaded to a site.  The site saved it under a /media/gallery/ directory (under the webroot with PHP enabled) and he had arbitrary PHP execution on the server.  The lesson learned was <strong>always re-encode user images when they are submitted</strong>.  Even if you're re-encoding from PNG to PNG, strip the comments - it's not worth it to find out there was something malicious in them later on.</p>
<p>For many sites session cookies are one of the most valuable assets behind the actual credentials to log in.  AMO protects the session cookie (and most of its cookies) with two very underused options: the <strong>Secure and HTTPOnly flags</strong>.  Secure simply means the cookie is only sent over a secure connection - that means that when you go to addons.mozilla.org without typing the https, your cookies (and therefore your session) aren't sent and won't be compromised if someone is eavesdropping.  <a href="https://www.owasp.org/index.php/HttpOnly">HTTPOnly</a> means that the cookies are sent with browser traffic to AMO but the cookie is inaccessible to client side scripts.  If a malicious script is somehow injected into the page this option will prevent it from stealing the session id.  Assuming you don't need access to the cookies and are running SSL these are essentially free additional layers of security for your site.</p>
<p>Every request to AMO returns a pile of interesting (and sometimes bleeding edge) HTTP headers.  If you hit the front page, you'll see <strong>X-Frame-Options: DENY</strong>.  In a supporting browser, this will prevent someone from putting the AMO site into an &lt;iframe&gt; (which prevents things like <a href="http://en.wikipedia.org/wiki/Clickjacking">clickjacking</a>).  The vast majority of sites can add this header for more free security.</p>
<p>In a couple examples above I say that once you get to AMO on SSL you'll be fine but I conveniently skip all the traffic and redirects up until then.  An attempt to keep people safe until they reach that point is the <strong>Strict-Transport-Security: max-age=2592000</strong> header.  This tells the browser that for the next 30 days, if you type in addons.mozilla.org without https it will automatically send it over SSL before the initial request - no unencrypted traffic at all.  Support for this header is not widespread yet, but it's in all the recent versions of Firefox and I expect support for it to expand.</p>
<p>I can't mention "bleeding edge" and "headers" without a hat tip to the <strong>Content Security Policy</strong> (<a href="https://wiki.mozilla.org/Security/CSP/Specification">specifications</a>).  We've had it in reporting mode for a couple months as we work out what needs to be adjusted before we turn it on, but once we do, this will (again, in a supporting browser) define specific rules for what domains will have valid assets (like images, JavaScript, CSS, etc.) as well as disallow any inline JavaScript from executing.  This essentially locks down XSS attacks even if someone does find a way to inject code into the page.  It's a really exciting development but not for the faint of heart to implement on a complex site at this point in time.  There are still some bugs to iron out and some edge cases to clarify in CSP but it's becoming something to seriously consider.  I think <a href="http://engineering.twitter.com/2011/03/improving-browser-security-with-csp.html">Twitter is the most prominent site using it to enforce rules</a> (as opposed to only reporting violations) at this time.</p>
<p>Whew, that is a pile of text and that's just covering the extreme front end.  I'm going to cut it off there to keep this from running on for pages but if there is interest I'll write another post about more things AMO does to defend itself and its visitors, and other areas where everyone can consider adding in extra security.  </p>
<p>In the mean time, if you want even more best practices the Mozilla Security Team has made a <a href="https://wiki.mozilla.org/WebAppSec/Secure_Coding_Guidelines">great wiki page for further reading about web security</a>.</p>
